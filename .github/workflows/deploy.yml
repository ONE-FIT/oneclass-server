name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Create SSH key file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Make .ssh directory
        run: mkdir -p ~/.ssh

      - name: Add EC2 to known_hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Copy JAR to EC2
        run: scp -i key.pem build/libs/oneclass-0.0.1-SNAPSHOT.jar ubuntu@${{ secrets.EC2_HOST }}:~/

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'SCRIPT_END'
          #!/bin/bash
          
          echo "=== Starting deployment ==="
          
          # Stop existing Java process
          echo "Stopping existing application..."
          pkill -9 -f 'java -jar ~/oneclass-0.0.1-SNAPSHOT.jar' || true
          sleep 2
          
          # Set all environment variables
          export DB_HOST='${{ secrets.DB_HOST }}'
          export DB_PORT='${{ secrets.DB_PORT }}'
          export DB_NAME='${{ secrets.DB_NAME }}'
          export DB_USER='${{ secrets.DB_USER }}'
          export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
          export SPRING_DATASOURCE_URL='${{ secrets.SPRING_DATASOURCE_URL }}'
          export SPRING_DATASOURCE_USERNAME='${{ secrets.SPRING_DATASOURCE_USERNAME }}'
          export SPRING_DATASOURCE_PASSWORD='${{ secrets.SPRING_DATASOURCE_PASSWORD }}'
          export SPRING_MAIL_USERNAME='${{ secrets.SPRING_MAIL_USERNAME }}'
          export SPRING_MAIL_PASSWORD='${{ secrets.SPRING_MAIL_PASSWORD }}'
          export JWT_SECRET='${{ secrets.JWT_SECRET }}'
          export SMS_MOBILE_FROM='${{ secrets.SMS_MOBILE_FROM }}'
          export USER_ID='${{ secrets.USER_ID }}'
          export USER_APIKEY='${{ secrets.USER_APIKEY }}'
          
          # Start application in background
          echo "Starting new application..."
          nohup java -jar ~/oneclass-0.0.1-SNAPSHOT.jar > ~/app.log 2>&1 &
          
          echo "=== Deployment script completed ==="
          SCRIPT_END
          
          chmod +x deploy.sh

      - name: Create .env file from secrets
        run: |
          cat > .env << 'ENV_EOF'    

      - name: Copy deployment script to EC2
        run: scp -i key.pem deploy.sh ubuntu@${{ secrets.EC2_HOST }}:~/

      - name: Execute deployment on EC2
        run: ssh -i key.pem ubuntu@${{ secrets.EC2_HOST }} 'bash ~/deploy.sh'

      - name: Verify deployment
        run: |
          echo "Waiting 5 seconds for application to start..."
          sleep 5
          ssh -i key.pem ubuntu@${{ secrets.EC2_HOST }} '
            echo "=== Java Process Status ==="
            ps aux | grep "[j]ava -jar ~/oneclass-0.0.1-SNAPSHOT.jar" || echo "⚠️ Warning: Java process not found"
            echo ""
            echo "=== Last 30 lines of application log ==="
            tail -n 30 ~/app.log 2>/dev/null || echo "⚠️ Log file not created yet"
          '

      - name: Deployment completed
        run: echo "✅ Deployment to EC2 completed successfully!"